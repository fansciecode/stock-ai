{"ast":null,"code":"import React,{useState,useEffect}from'react';import{Container,Typography,Box,Paper,Divider,Button,Grid,CircularProgress,Rating,TextField,Card,CardContent,Avatar,List,ListItem,ListItemAvatar,ListItemText,IconButton,Chip,FormControl,InputLabel,Select,MenuItem}from'@mui/material';import{ArrowBack,Star,Send,ThumbUp,ThumbDown,SortRounded,PhotoCamera,Close,Event}from'@mui/icons-material';import{useParams,useNavigate}from'react-router-dom';import axios from'axios';import{useAuth}from'../../contexts/AuthContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const EventReviewScreen=()=>{var _displayEvent$ticketP;const{eventId}=useParams();const navigate=useNavigate();const{user}=useAuth();const[event,setEvent]=useState(null);const[reviews,setReviews]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[reviewText,setReviewText]=useState('');const[reviewRating,setReviewRating]=useState(5);const[reviewImages,setReviewImages]=useState([]);const[reviewFilter,setReviewFilter]=useState('all');const[reviewSort,setReviewSort]=useState('newest');const[submitting,setSubmitting]=useState(false);const[userHasAttended,setUserHasAttended]=useState(false);const[userHasReviewed,setUserHasReviewed]=useState(false);useEffect(()=>{fetchEventAndReviews();checkUserAttendanceStatus();},[eventId]);const fetchEventAndReviews=async()=>{try{setLoading(true);setError(null);// Use a default eventId for demo if none is provided\nconst id=eventId||'event-123';// Fetch event details and reviews in parallel\nconst[eventResponse,reviewsResponse]=await Promise.all([axios.get(`/api/events/${id}`),axios.get(`/api/events/${id}/reviews`)]);setEvent(eventResponse.data);setReviews(reviewsResponse.data);// Check if user has already reviewed this event\nif(user){const hasReviewed=reviewsResponse.data.some(review=>review.user&&review.user._id===user._id);setUserHasReviewed(hasReviewed);}setLoading(false);}catch(err){var _err$response,_err$response$data;setError(((_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||'Failed to load event and reviews');setLoading(false);}};const checkUserAttendanceStatus=async()=>{if(!user)return;try{const{data}=await axios.get(`/api/events/${eventId||'event-123'}/attendance-status`);setUserHasAttended(data.hasAttended);}catch(err){console.error('Failed to check attendance status:',err);// Default to true for demo purposes\nsetUserHasAttended(true);}};const handleSubmitReview=async e=>{e.preventDefault();if(!reviewText.trim()){return;}try{setSubmitting(true);// Prepare form data for images if needed\nlet formData=new FormData();formData.append('rating',reviewRating);formData.append('text',reviewText);reviewImages.forEach((image,index)=>{formData.append('images',image);});const{data}=await axios.post(`/api/events/${eventId||'event-123'}/reviews`,formData,{headers:{'Content-Type':'multipart/form-data'}});// Add the new review to the reviews list\nsetReviews([data,...reviews]);// Reset form\nsetReviewText('');setReviewRating(5);setReviewImages([]);setUserHasReviewed(true);setSubmitting(false);}catch(err){console.error('Failed to submit review:',err);setSubmitting(false);alert('Failed to submit review. Please try again.');}};const handleImageUpload=e=>{const files=Array.from(e.target.files);if(files.length>0){setReviewImages([...reviewImages,...files].slice(0,5));// Limit to 5 images\n}};const handleRemoveImage=index=>{setReviewImages(reviewImages.filter((_,i)=>i!==index));};const handleFilterChange=e=>{setReviewFilter(e.target.value);};const handleSortChange=e=>{setReviewSort(e.target.value);};const handleVoteReview=async(reviewId,voteType)=>{try{await axios.post(`/api/reviews/${reviewId}/vote`,{voteType});// Update the review in the list\nsetReviews(reviews.map(review=>{if(review._id===reviewId){if(voteType==='upvote'){return{...review,helpfulVotes:review.helpfulVotes+1,userVoted:true,userVoteType:'upvote'};}else{return{...review,notHelpfulVotes:review.notHelpfulVotes+1,userVoted:true,userVoteType:'downvote'};}}return review;}));}catch(err){console.error('Failed to vote on review:',err);}};const getFilteredAndSortedReviews=()=>{// First, filter the reviews\nlet filteredReviews=[...reviews];switch(reviewFilter){case'positive':filteredReviews=filteredReviews.filter(review=>review.rating>=4);break;case'neutral':filteredReviews=filteredReviews.filter(review=>review.rating===3);break;case'negative':filteredReviews=filteredReviews.filter(review=>review.rating<=2);break;case'withPhotos':filteredReviews=filteredReviews.filter(review=>review.images&&review.images.length>0);break;case'verified':filteredReviews=filteredReviews.filter(review=>review.verifiedAttendee);break;default:// 'all' - no filtering needed\nbreak;}// Then, sort the filtered reviews\nswitch(reviewSort){case'helpful':filteredReviews.sort((a,b)=>b.helpfulVotes-a.helpfulVotes);break;case'highest':filteredReviews.sort((a,b)=>b.rating-a.rating);break;case'lowest':filteredReviews.sort((a,b)=>a.rating-b.rating);break;case'oldest':filteredReviews.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));break;default:// 'newest' - default sort\nfilteredReviews.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));break;}return filteredReviews;};const formatDate=dateString=>{return new Date(dateString).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});};if(loading){return/*#__PURE__*/_jsx(Box,{display:\"flex\",justifyContent:\"center\",alignItems:\"center\",minHeight:\"80vh\",children:/*#__PURE__*/_jsx(CircularProgress,{})});}if(error){return/*#__PURE__*/_jsx(Container,{maxWidth:\"md\",children:/*#__PURE__*/_jsxs(Box,{my:4,textAlign:\"center\",children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",color:\"error\",gutterBottom:true,children:error}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:fetchEventAndReviews,children:\"Try Again\"})]})});}// Demo event data if none is available\nconst demoEvent={_id:'event-123',title:'Summer Music Festival',image:'https://via.placeholder.com/400x200?text=Summer+Music+Festival',rating:4.7,numReviews:32,date:new Date(Date.now()+7*24*60*60*1000).toISOString(),time:'18:00',location:'Central Park, New York',ticketPrice:79.99,category:'Music Festival'};// Demo reviews if none are available\nconst demoReviews=[{_id:'review-1',rating:5,text:'Best festival I\\'ve been to this year! The performances were amazing and the organization was perfect.',createdAt:new Date(Date.now()-7*24*60*60*1000).toISOString(),user:{_id:'user-1',name:'John Smith',avatar:'https://via.placeholder.com/50'},helpfulVotes:17,notHelpfulVotes:2,verifiedAttendee:true,images:[]},{_id:'review-2',rating:4,text:'Great performances but the food options were limited. The sound quality was excellent though!',createdAt:new Date(Date.now()-14*24*60*60*1000).toISOString(),user:{_id:'user-2',name:'Emily Johnson',avatar:'https://via.placeholder.com/50'},helpfulVotes:8,notHelpfulVotes:1,verifiedAttendee:true,images:['https://via.placeholder.com/100?text=Festival+Photo']},{_id:'review-3',rating:2,text:'Too crowded and overpriced. Long lines for bathrooms and the headliner was 30 minutes late.',createdAt:new Date(Date.now()-21*24*60*60*1000).toISOString(),user:{_id:'user-3',name:'Robert Davis',avatar:'https://via.placeholder.com/50'},helpfulVotes:12,notHelpfulVotes:8,verifiedAttendee:true,images:[]},{_id:'review-4',rating:5,text:'Incredible atmosphere and the lineup was fantastic! Will definitely attend next year. The light show during the main act was breathtaking.',createdAt:new Date(Date.now()-3*24*60*60*1000).toISOString(),user:{_id:'user-4',name:'Sarah Miller',avatar:'https://via.placeholder.com/50'},helpfulVotes:24,notHelpfulVotes:1,verifiedAttendee:true,images:['https://via.placeholder.com/100?text=Photo+1','https://via.placeholder.com/100?text=Photo+2']}];const displayEvent=event||demoEvent;const displayReviews=reviews.length>0?reviews:demoReviews;const filteredAndSortedReviews=getFilteredAndSortedReviews();// Calculate rating statistics\nconst ratingCounts={5:displayReviews.filter(r=>r.rating===5).length,4:displayReviews.filter(r=>r.rating===4).length,3:displayReviews.filter(r=>r.rating===3).length,2:displayReviews.filter(r=>r.rating===2).length,1:displayReviews.filter(r=>r.rating===1).length};return/*#__PURE__*/_jsx(Container,{maxWidth:\"lg\",children:/*#__PURE__*/_jsxs(Box,{my:4,children:[/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mb:3,children:[/*#__PURE__*/_jsx(IconButton,{onClick:()=>navigate(-1),sx:{mr:1},children:/*#__PURE__*/_jsx(ArrowBack,{})}),/*#__PURE__*/_jsx(Typography,{variant:\"h4\",component:\"h1\",children:\"Event Reviews\"})]}),/*#__PURE__*/_jsx(Paper,{elevation:3,sx:{p:3,mb:4},children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:3,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,children:/*#__PURE__*/_jsx(Box,{component:\"img\",src:displayEvent.image,alt:displayEvent.title,sx:{width:'100%',borderRadius:1}})}),/*#__PURE__*/_jsxs(Grid,{item:true,xs:12,sm:9,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",gutterBottom:true,children:displayEvent.title}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mb:1,children:[/*#__PURE__*/_jsx(Rating,{value:displayEvent.rating,precision:0.5,readOnly:true}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",color:\"text.secondary\",sx:{ml:1},children:[displayEvent.rating.toFixed(1),\" (\",displayEvent.numReviews,\" reviews)\"]})]}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mb:1,children:[/*#__PURE__*/_jsx(Event,{color:\"action\",sx:{mr:1},fontSize:\"small\"}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",children:[formatDate(displayEvent.date),\" at \",displayEvent.time]})]}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",gutterBottom:true,children:displayEvent.location}),/*#__PURE__*/_jsxs(Typography,{variant:\"body1\",color:\"primary\",gutterBottom:true,children:[\"$\",(_displayEvent$ticketP=displayEvent.ticketPrice)===null||_displayEvent$ticketP===void 0?void 0:_displayEvent$ticketP.toFixed(2)]}),/*#__PURE__*/_jsx(Chip,{label:displayEvent.category,size:\"small\",sx:{mt:1}}),/*#__PURE__*/_jsx(Box,{mt:2,children:/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:()=>navigate(`/events/${displayEvent._id}`),children:\"View Event\"})})]})]})}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:4,children:[/*#__PURE__*/_jsxs(Grid,{item:true,xs:12,md:4,children:[/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{p:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Rating Summary\"}),/*#__PURE__*/_jsx(Divider,{sx:{mb:2}}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mb:2,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h3\",component:\"span\",sx:{mr:1},children:displayEvent.rating.toFixed(1)}),/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Rating,{value:displayEvent.rating,precision:0.5,readOnly:true}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",color:\"text.secondary\",children:[displayEvent.numReviews,\" reviews\"]})]})]}),[5,4,3,2,1].map(rating=>/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mb:1,children:[/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",sx:{minWidth:30},children:[rating,\"\\u2605\"]}),/*#__PURE__*/_jsx(Box,{sx:{flexGrow:1,bgcolor:'action.hover',borderRadius:1,mx:1,height:10,overflow:'hidden'},children:/*#__PURE__*/_jsx(Box,{sx:{width:`${ratingCounts[rating]/displayEvent.numReviews*100}%`,bgcolor:rating>3?'success.main':rating===3?'warning.main':'error.main',height:'100%'}})}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",children:ratingCounts[rating]})]},rating)),user&&!userHasReviewed&&/*#__PURE__*/_jsx(Button,{variant:\"contained\",fullWidth:true,sx:{mt:3},onClick:()=>document.getElementById('write-review').scrollIntoView({behavior:'smooth'}),children:\"Write a Review\"})]}),user&&!userHasReviewed&&userHasAttended&&/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{p:3,mt:3},id:\"write-review\",children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Write a Review\"}),/*#__PURE__*/_jsx(Divider,{sx:{mb:2}}),/*#__PURE__*/_jsxs(Box,{component:\"form\",onSubmit:handleSubmitReview,children:[/*#__PURE__*/_jsxs(Box,{mb:2,children:[/*#__PURE__*/_jsx(Typography,{component:\"legend\",children:\"Your Rating\"}),/*#__PURE__*/_jsx(Rating,{name:\"rating\",value:reviewRating,onChange:(e,newValue)=>setReviewRating(newValue),size:\"large\"})]}),/*#__PURE__*/_jsx(TextField,{label:\"Your Review\",multiline:true,rows:6,value:reviewText,onChange:e=>setReviewText(e.target.value),fullWidth:true,margin:\"normal\",required:true,placeholder:\"Share your experience at this event...\"}),reviewImages.length>0&&/*#__PURE__*/_jsx(Box,{sx:{mt:2,display:'flex',flexWrap:'wrap',gap:1},children:reviewImages.map((image,index)=>/*#__PURE__*/_jsxs(Box,{sx:{position:'relative',width:80,height:80},children:[/*#__PURE__*/_jsx(Box,{component:\"img\",src:URL.createObjectURL(image),alt:`Review image ${index+1}`,sx:{width:'100%',height:'100%',objectFit:'cover',borderRadius:1}}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>handleRemoveImage(index),sx:{position:'absolute',top:-10,right:-10,bgcolor:'background.paper',boxShadow:1,p:0.5},children:/*#__PURE__*/_jsx(Close,{fontSize:\"small\"})})]},index))}),/*#__PURE__*/_jsxs(Box,{mt:2,display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",children:[/*#__PURE__*/_jsxs(Button,{component:\"label\",startIcon:/*#__PURE__*/_jsx(PhotoCamera,{}),disabled:reviewImages.length>=5,children:[\"Add Photos\",/*#__PURE__*/_jsx(\"input\",{type:\"file\",hidden:true,accept:\"image/*\",multiple:true,onChange:handleImageUpload})]}),/*#__PURE__*/_jsx(Button,{type:\"submit\",variant:\"contained\",color:\"primary\",endIcon:/*#__PURE__*/_jsx(Send,{}),disabled:submitting||!reviewText.trim(),children:submitting?'Submitting...':'Submit Review'})]})]})]}),!userHasAttended&&user&&!userHasReviewed&&/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{p:3,mt:3,bgcolor:'info.light'},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body1\",gutterBottom:true,children:\"You need to attend this event before you can leave a review.\"}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:()=>navigate(`/events/${displayEvent._id}`),sx:{mt:1},children:\"View Event\"})]}),userHasReviewed&&/*#__PURE__*/_jsx(Paper,{elevation:3,sx:{p:3,mt:3,bgcolor:'success.light'},children:/*#__PURE__*/_jsx(Typography,{variant:\"body1\",children:\"Thank you for reviewing this event!\"})})]}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:8,children:/*#__PURE__*/_jsxs(Paper,{elevation:3,sx:{p:3},children:[/*#__PURE__*/_jsxs(Box,{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",mb:2,children:[/*#__PURE__*/_jsxs(Typography,{variant:\"h6\",children:[\"Attendee Reviews (\",displayReviews.length,\")\"]}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",size:\"small\",sx:{minWidth:120,mr:1},children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Filter\"}),/*#__PURE__*/_jsxs(Select,{value:reviewFilter,onChange:handleFilterChange,label:\"Filter\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"all\",children:\"All Reviews\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"positive\",children:\"Positive (4-5\\u2605)\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"neutral\",children:\"Neutral (3\\u2605)\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"negative\",children:\"Negative (1-2\\u2605)\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"withPhotos\",children:\"With Photos\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"verified\",children:\"Verified Attendees\"})]})]}),/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",size:\"small\",sx:{minWidth:120},children:[/*#__PURE__*/_jsx(InputLabel,{children:\"Sort By\"}),/*#__PURE__*/_jsxs(Select,{value:reviewSort,onChange:handleSortChange,label:\"Sort By\",endAdornment:/*#__PURE__*/_jsx(SortRounded,{}),children:[/*#__PURE__*/_jsx(MenuItem,{value:\"newest\",children:\"Newest First\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"oldest\",children:\"Oldest First\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"helpful\",children:\"Most Helpful\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"highest\",children:\"Highest Rated\"}),/*#__PURE__*/_jsx(MenuItem,{value:\"lowest\",children:\"Lowest Rated\"})]})]})]})]}),/*#__PURE__*/_jsx(Divider,{sx:{mb:2}}),filteredAndSortedReviews.length===0?/*#__PURE__*/_jsxs(Box,{textAlign:\"center\",py:3,children:[/*#__PURE__*/_jsx(Typography,{color:\"textSecondary\",children:\"No reviews match your current filter.\"}),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",sx:{mt:2},onClick:()=>setReviewFilter('all'),children:\"Clear Filters\"})]}):/*#__PURE__*/_jsx(List,{children:filteredAndSortedReviews.map(review=>{var _review$user,_review$user2,_review$user3,_review$user3$name,_review$user4;return/*#__PURE__*/_jsx(Card,{sx:{mb:3},children:/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(ListItem,{sx:{px:0},alignItems:\"flex-start\",children:[/*#__PURE__*/_jsx(ListItemAvatar,{children:/*#__PURE__*/_jsx(Avatar,{src:(_review$user=review.user)===null||_review$user===void 0?void 0:_review$user.avatar,alt:((_review$user2=review.user)===null||_review$user2===void 0?void 0:_review$user2.name)||'Anonymous',children:((_review$user3=review.user)===null||_review$user3===void 0?void 0:(_review$user3$name=_review$user3.name)===null||_review$user3$name===void 0?void 0:_review$user3$name.charAt(0))||'A'})}),/*#__PURE__*/_jsx(ListItemText,{primary:/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",children:[/*#__PURE__*/_jsx(Typography,{variant:\"subtitle1\",component:\"span\",children:((_review$user4=review.user)===null||_review$user4===void 0?void 0:_review$user4.name)||'Anonymous'}),review.verifiedAttendee&&/*#__PURE__*/_jsx(Chip,{label:\"Verified Attendee\",size:\"small\",color:\"success\",sx:{ml:1,height:20}})]}),secondary:/*#__PURE__*/_jsxs(Box,{component:\"span\",children:[/*#__PURE__*/_jsx(Rating,{value:review.rating,size:\"small\",readOnly:true}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",component:\"span\",sx:{ml:1},children:formatDate(review.createdAt)})]})})]}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",paragraph:true,sx:{mt:1},children:review.text}),review.images&&review.images.length>0&&/*#__PURE__*/_jsx(Box,{display:\"flex\",gap:1,mb:2,flexWrap:\"wrap\",children:review.images.map((image,index)=>/*#__PURE__*/_jsx(Box,{component:\"img\",src:image,alt:`Review image ${index+1}`,sx:{width:80,height:80,objectFit:'cover',borderRadius:1,cursor:'pointer'},onClick:()=>{// Image viewer logic could go here\n}},index))}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",justifyContent:\"space-between\",children:[/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:\"Was this review helpful?\"}),/*#__PURE__*/_jsxs(Box,{display:\"flex\",alignItems:\"center\",mt:0.5,children:[/*#__PURE__*/_jsxs(Button,{size:\"small\",startIcon:/*#__PURE__*/_jsx(ThumbUp,{}),onClick:()=>handleVoteReview(review._id,'upvote'),disabled:review.userVoted,color:review.userVoteType==='upvote'?'primary':'inherit',children:[\"Yes (\",review.helpfulVotes,\")\"]}),/*#__PURE__*/_jsxs(Button,{size:\"small\",startIcon:/*#__PURE__*/_jsx(ThumbDown,{}),onClick:()=>handleVoteReview(review._id,'downvote'),disabled:review.userVoted,color:review.userVoteType==='downvote'?'primary':'inherit',sx:{ml:1},children:[\"No (\",review.notHelpfulVotes,\")\"]})]})]}),user&&review.user&&user._id===review.user._id&&/*#__PURE__*/_jsx(Button,{size:\"small\",color:\"error\"// Delete review functionality could go here\n,children:\"Delete Review\"})]})]})},review._id);})})]})})]})]})});};export default EventReviewScreen;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}